# 3パス化実装プラン: モデル分業の最適化

## 背景

現在の2パス方式では Opus がテーマ選定時に WebSearch を行うため、
Opus の応答速度 × 検索レイテンシでタイムアウト (600-900s) が頻発する。

各モデルの得意分野に合わせた分業に変更する。

## 現状 (2パス)

```
Pass 1 (Opus):  config読み → WebSearch 7回 → スコアリング → JSON
Pass 2 (Sonnet): リサーチ・執筆
```

問題: Opus に検索（量の仕事）をさせている。遅い・高い・タイムアウトする。

## 提案 (3パス)

```
Pass 0 (Sonnet): config読み → WebSearch → トレンド候補リスト出力
Pass 1 (Opus):   トレンド候補 + past_topics → 多軸スコアリング → 2テーマ選定 JSON
Pass 2 (Sonnet): 選定テーマの深掘りリサーチ → レポート執筆
```

### 各パスの役割と使用モデルの理由

| Pass | モデル | 役割 | なぜこのモデルか |
|------|--------|------|------------------|
| 0 | Sonnet | 検索クエリ設計 + 結果要約 | 検索の質と速度のバランス。Haiku では検索クエリが素朴すぎる |
| 1 | Opus | 多軸スコアリング + テーマ選定 | 深い推論による判断。ツール不要なので 300s で十分 |
| 2 | Sonnet | 深掘りリサーチ + レポート執筆 | 調査と執筆のバランス。現行と同じ |

### Pass 0 の出力形式 (案)

```json
{
  "searched_at": "2026-02-20",
  "tech_trends": [
    {
      "title": "トレンドのタイトル",
      "source": "情報源 URL",
      "summary": "2-3文の要約",
      "relevance": "config.toml のどのドメインに該当するか"
    }
  ],
  "personal_trends": [...]
}
```

### Pass 1 の入力

- Pass 0 の JSON 出力 (トレンド候補)
- past_topics.json の内容 (重複排除用)
- config.toml のスコアリング基準 (プロンプトに埋め込み)

### Pass 1 の出力

現行と同じ themes JSON。

## タイムアウト設定

| Pass | 現行 | 提案 | 理由 |
|------|------|------|------|
| 0 (Sonnet 検索) | - | 600s | 検索 + 要約 |
| 1 (Opus 判断) | 600s | 300s | ツール不要、純粋な推論のみ |
| 2 (Sonnet 執筆) | 1800s | 1800s | 変更なし |

## コスト見積もり

| Pass | モデル | 推定コスト |
|------|--------|-----------|
| 0 | Sonnet | ~$0.10 |
| 1 | Opus | ~$0.20 (入力のみ、出力は短い) |
| 2 | Sonnet | ~$1.50 |
| **合計** | | **~$1.80** (現行 ~$1.80 と同等) |

## 実装手順

1. `prompts/trend-search-prompt.md` を新規作成 (Pass 0 用)
2. `prompts/theme-selection-prompt.md` を修正 (検索結果を受け取る形に)
3. `scripts/daily-research.sh` に Pass 0 を追加
4. Pass 0 出力の JSON バリデーション関数を追加
5. フォールバック: Pass 0 or 1 失敗時は Sonnet 一括実行 (現行フォールバック)
6. E2E テスト更新 (3パスの mock テスト追加)

## フォールバック戦略

```
Pass 0 失敗 → Sonnet 一括実行 (現行フォールバック)
Pass 1 失敗 → Sonnet 一括実行 (現行フォールバック)
Pass 0 成功 + Pass 1 失敗 → Pass 0 の結果を Sonnet に渡してテーマ選定+執筆
```

## 未決事項

- Pass 0 で何件の候補を出力するか (5件? 8件?)

## 棄却した代替案

### Opus クエリ設計 → Haiku 検索 → Opus スコアリング

Opus に検索クエリ設計だけさせ、安価な Haiku で WebSearch を実行する案。

**棄却理由:**
1. Opus はクエリ設計にオーバースペック（「広さ」の仕事に「深さ」のモデルは不要）
2. Haiku の要約品質が Pass 1 のボトルネックになる（ニュアンス・文脈が薄くなる）
3. `claude -p` 1回追加のオーバーヘッド（起動 ~5-10秒、フォールバック複雑化）
4. Pass 0+1 はパイプライン全体の ~17%。内部最適化のコスト削減効果が微小

### 本プラン自体の位置づけ

3パス化は Opus テーマ選定に有意な品質差があると検証できた場合の拡張案。
現時点では **Sonnet 一括 (2パス) でベースライン運用** し、テーマ品質を評価した上で判断する。
