# ポストモーテム: gtimeout による Pass 1 障害と人間介入による問題切り分け (2026-02-20)

## 概要

2026-02-20 AM 5:00 の launchd 自動実行で Pass 1 (Opus テーマ選定) が即座に失敗し、レポートが生成されなかった。原因は `gtimeout` が `claude` コマンドを見つけられなかったこと (ENOENT)。修正後の手動実行では Opus → Sonnet の2パス方式が正常に完了した。

本ポストモーテムでは、技術的な原因に加えて、AI コーディングアシスタントによるデバッグの盲点と人間介入の有効性についても記録する。

---

## タイムライン

| 時刻 | イベント | 結果 |
|------|---------|------|
| 05:00:01 | launchd 自動実行 | **失敗**: `gtimeout: failed to run command 'claude': No such file or directory` (exit 127) |
| 05:00:01 | `exit $PASS1_EXIT` | フォールバックなし。スクリプト即終了 |
| 06:37 | Claude Code 自動アップデート完了 | `cli.js` と symlink のタイムスタンプ更新 |
| — | Claude Code セッションで原因究明開始 | — |
| — | 修正コミット (`c7969ce`) | CLAUDE_CMD 絶対パス化 + Sonnet フォールバック復元 |
| — | gtimeout 自体を除去 (`e832507`) | ユーザーが別途実施 |
| 07:01 | 手動実行 1回目 | Pass 1 **タイムアウト** (600s) → Sonnet フォールバック成功 |
| 07:32 | 手動実行 2回目 | Pass 1 **成功** (2分38秒) → Pass 2 成功 (8分27秒) |
| 07:43 | レポート2本生成完了 | `$1.76` |

---

## 根本原因

### 直接原因: gtimeout の execvp が ENOENT

`claude` コマンドの実体は symlink チェーン:

```
/opt/homebrew/bin/claude  (symlink)
  → ../lib/node_modules/@anthropic-ai/claude-code/cli.js  (#!/usr/bin/env node)
    → /opt/homebrew/bin/node
```

`gtimeout` は内部で `execvp("claude", ...)` を呼ぶ。このとき OS カーネルが symlink チェーンを辿る過程で、チェーンのいずれかが一時的に不在だった。

証拠: `cli.js` と symlink のタイムスタンプが `06:37:47`（スクリプト実行の 05:00:01 より後）。Claude Code の自動アップデートが裏で走り、npm パッケージの入れ替え中に `cli.js` が一時的に消失したと推測される。

同じスクリプト内の `claude --version` はシェルが直接実行しており、アップデート開始前に完了したため成功した。

### 悪化要因: フォールバックの欠如

コミット `1ce4375` ("テーマ選定の責務を Opus に一元化し重複指示を削除") で Sonnet フォールバックが削除されていた。Pass 1 の失敗が即 `exit` となり、回復手段がなかった。

### 二次的問題: gtimeout とプロセスグループ

手動実行 1回目で gtimeout が Pass 1 を 600秒でタイムアウト kill した。しかし gtimeout 除去後の2回目は 2分38秒で正常完了。gtimeout のプロセスグループ分離が `claude -p` の動作に干渉していた可能性がある（ユーザーが `e832507` で gtimeout を除去し、`--max-turns` のみで制御する方式に変更）。

---

## 修正内容

| 修正 | コミット | 内容 |
|------|---------|------|
| CLAUDE_CMD 絶対パス化 | `c7969ce` | `command -v claude` で絶対パスを解決し、`run_claude` 内で使用 |
| Sonnet フォールバック復元 | `c7969ce` | Pass 1 失敗時に Sonnet がテーマ選定 + リサーチを一括実行 |
| デバッグログ追加 | `c7969ce` | PATH と CLAUDE_CMD をログに記録 |
| gtimeout 除去 | `e832507` | プロセスグループ分離問題を根本回避。`--max-turns` のみで制御 |
| MEM0_API_KEY 削除 | (plist, gitignore対象) | 棚上げ済み機能の残骸を除去 |
| WebSearch 回数制限撤廃 | `d9ef316` | Opus が自律的に検索回数を判断できるよう人為的制限を削除 |
| mock E2E テスト追加 | `c7969ce` | 正常パス・フォールバック2パターンの自動テスト (7件) |

---

## 人間介入の有効性: AI デバッグの盲点

今回のデバッグ過程で、AI コーディングアシスタント (Claude Code) の問題切り分けにおける構造的な傾向が明らかになった。

### 観察された傾向

Claude Code に原因究明を依頼した際、最初のアプローチは以下だった:

1. 2/19 のログ（別の原因による失敗）を含めた広範なデータ分析
2. WebSearch 回数の削減、プロンプト最適化など、**自らが直近で実装した箇所** への改修提案
3. API レイテンシ、プロンプトキャッシュなど、間接的な仮説の積み上げ

これは人間の開発者にも見られる「自分が触ったコードに原因があるはず」という認知バイアスに類似している。

### 人間の介入が効いたポイント

ユーザーが以下の指摘で問題を切り分けた:

- **「2/19 のログは別原因。当てになるのは今日の成功ログだけ」** → ノイズの除去
- **「2回目は改修後。WebSearch 削減前に成功している」** → 不要な修正の阻止
- **「回数制限を撤廃して。Opus は自律的にやめ時を考えられる」** → 過剰な制約の除去

いずれも「問題が発生した時点の事実」に着目し、無関係な変数を排除する判断だった。

### 教訓

> AI コーディングアシスタントは、直近の作業コンテキストに引きずられて問題の切り分けが甘くなる傾向がある。これは人間の開発者と同じ認知バイアスであり、「最近触った箇所に原因がある」という思い込みとして現れる。
>
> 効果的な対処法は、人間が **問題発生時点の事実** に着目し、関連するデータと無関連なデータを明確に切り分けること。AI が広く浅く分析しようとする時に、人間が「ここだけ見ろ」と焦点を絞るのが最も効率的なデバッグの分業になる。

---

## 最終状態

- 2パス方式 (Opus テーマ選定 → Sonnet リサーチ) が本番で動作確認済み
- gtimeout 除去済み。タイムアウト制御は `--max-turns` のみ
- Sonnet フォールバックあり。Opus 不調時もレポートは生成される
- mock E2E テスト 7件 + 既存テスト 21件 = 計 28件、全パス
