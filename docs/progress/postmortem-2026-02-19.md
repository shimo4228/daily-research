# ポストモーテム: Mem0 統合・2パス方式・エージェントチーム改修 (2026-02-19)

## 概要

2026-02-18〜19 にかけて、daily-research パイプラインに3つの機能拡張を同時に実施した。結果として全てスタックし、9コミット分のリバート + 軽量な再実装に至った。本ドキュメントはその顛末、スタックポイント、学びを記録する。

---

## タイムライン

### 2026-02-18（前日）

| 時刻 | コミット | 内容 |
|------|---------|------|
| 21:17 | `a79074e` | セキュリティレビュー対応7件 |
| 22:09 | `fd405d2` | **Mem0 Cloud MCP 統合 (Phase 0-3)** |
| 22:44 | `ffc2a7f` | Mem0 MCP ツール名修正 |
| 22:52 | `2c192b7` | bash 3.2 空配列バグ修正 |
| 22:57 | `96226df` | コードレビュー対応 |
| 22:58 | `5dc7ce3` | セキュリティレビュー対応 |
| 23:07 | `208f14f` | pre-commit hook 追加 |

### 2026-02-19（当日）

| 時刻 | イベント | 結果 |
|------|---------|------|
| 05:00 | launchd 自動実行（旧シングルパス Sonnet） | **成功**（7分、$1.78） |
| 05:07 | チーム版チェーン実行（Opus 司令塔） | **成功**（62分、$3.53） |
| 07:20 | `3e6a5f0`: 2パス方式実装 | — |
| 07:21 | 2パス 1回目の手動実行 | **失敗**: Pass 1 タイムアウト(10分)、Pass 2 タイムアウト(30分) |
| 07:43 | `4e0b149`: レビュー対応 | — |
| 08:12 | 2パス 2回目の手動実行 | **失敗**: 同上（15分+45分） |
| 12:13 | 2パス 3回目の手動実行 | **失敗**: 同上。手動 kill |
| 12:41 | `6924745`: MCP 退避コード追加 | — |
| 12:57 | 2パス 4回目（MCP 退避あり、モバイル環境） | **失敗**: SSH 切断で SIGHUP |
| 13:33 | 2パス 5回目（同一ターミナルで実行） | **失敗**: claude -p が SIGTSTP でサスペンド |
| 14:10 | 手動 kill | — |
| 14:30頃 | `a79074e` にリバート + 軽量再実装 | — |

---

## スタックポイント

### 1. MCP 初期化ハング（根本原因）

**現象**: `claude -p` が `.mcp.json` を読み、npx 経由で Mem0 MCP サーバーを起動しようとしてハングする。出力ゼロのまま 15分でタイムアウト。

**なぜ気づかなかったか**:
- Mem0 の seed-memory テスト（対話セッション）では MCP は正常に動作していた
- `claude -p`（非対話モード）での MCP 初期化は未テストだった
- launchd 環境（AM 5:00）では npx が PATH にないため MCP 初期化が即失敗 → 結果的に成功していた。つまり「本番では動くが手動では動かない」という逆のパターン

**時系列上の問題**:
- 2パス方式（`3e6a5f0`、07:20）の実装時点で MCP 退避コードが含まれていなかった
- MCP 退避コード（`6924745`）が追加されたのは 12:41 — 3回の失敗の後
- さらに、退避コードが入った 4回目も別の理由（SSH 切断）で失敗した

### 2. 同一ターミナル問題

**現象**: Claude Code の対話セッションと同じターミナルで `./scripts/daily-research.sh` を実行すると、`claude -p` プロセスが **T（サスペンド）** 状態になる。

**原因**: 同じ TTY で 2つの claude プロセスが競合し、バックグラウンドの `claude -p` が SIGTSTP を受ける。

**なぜ繰り返したか**: 問題の切り分けが難しかった。MCP ハングの修正後に初めてこの問題が顕在化し、MCP 問題と混同した。

### 3. SSH/モバイル環境からの実行

**現象**: tmux なしで SSH 接続し、スクリプト実行中に接続が切れた。SIGHUP で全プロセスが kill された。

**影響**: `.mcp.json` の復元が不完全になった（trap に HUP が含まれていなかった）。

### 4. past_topics.json の Edit 権限

**現象**: AM 5:00 の成功した実行でも、`past_topics.json` の更新が `Edit` ツール権限拒否で失敗していた。

**原因**: `--allowedTools` に `Write` はあるが `Edit` がなかった。Sonnet が `past_topics.json` を更新する際に Edit ツールを選択した。

---

## エージェントチーム版の問題点

### 費用対効果

| 指標 | Sonnet シングルパス | チーム版 (Opus + Haiku) |
|------|-------------------|----------------------|
| 所要時間 | 7分 | 62分（9倍） |
| コスト | $1.78 | $3.53（2倍） |
| 品質スコア (LLM-as-Judge 平均) | 53.0/70 | 57.1/70（+8%） |
| テーマ選定スコア | 6.5/10 | 8.3/10（+28%） |
| 月間コスト（毎日実行） | 〜$54 | 〜$54 + $106 = $160 |

### テーマ選定の質は高かったが、他は差が小さい

ブラインド LLM-as-Judge 評価（02-18, 02-19 の全 12 レポート）で、チーム版は**テーマ選定**で一貫して上回った。しかしリサーチの深さ・具体性・散文品質では差が小さく、9倍の時間と2倍のコストに見合わなかった。

### サブエージェントのモデル問題

チーム版の設計意図は「Opus 司令塔 + Sonnet リサーチャー/ライター」だったが、実際には **Task ツールで spawn されたサブエージェントは Haiku にフォールバック** していた。`--model opus` はメインエージェントにのみ適用され、サブエージェントには継承されなかった。

結果として「Opus が指示を出し、Haiku が実行する」という構図になり、Sonnet の能力がまったく活用されていなかった。

### 委任のオーバーヘッド

Opus オーケストレーターが全ステップの中間成果を自身のコンテキストに蓄積し続けるため:
- サブエージェントの結果をまるごと取り込む → コンテキスト膨張
- 各 Task の起動・応答待ちのラウンドトリップ
- Opus は Sonnet より token 生成が遅い
- Mem0 の 6回以上の API ラウンドトリップ

「委任のオーバーヘッド > 並列化のメリット」となっていた。

---

## 同時実装の問題

今回、以下の3機能を 1セッションで同時に実装した:

1. **Mem0 Cloud MCP 統合**（02-18 22:09）
2. **エージェントチーム版**（02-18 以前から存在、本番チェーン実行を追加）
3. **Opus テーマ選定 2パス方式**（02-19 07:20）

### なぜ問題だったか

- **障害の切り分けが困難**: `claude -p` がハングした時、原因が MCP か、Opus の遅さか、ターミナル問題か、判別できなかった
- **修正が別の問題を生んだ**: MCP 退避コードを追加 → SSH 切断問題が発覚 → ターミナル問題が発覚、と問題が連鎖した
- **テストの前提が崩れた**: Mem0 は対話セッションでテスト済みだったが、`claude -p` との組み合わせは未テスト。2パス方式は MCP が動く前提で設計されていた
- **リバート範囲が拡大**: 1機能ずつ入れていれば問題のある機能だけ戻せたが、9コミットまとめてリバートせざるを得なかった

### 教訓

> **1つの機能を入れて、動作確認してから次に進む。** 特に `claude -p` のようなランタイム環境が関わる変更は、E2E テストを通すまで次の機能に着手しない。

---

## 技術的に改善されれば実現できる機能

### 1. Mem0 永続メモリ（Claude Code MCP 改善待ち）

- **ブロッカー**: `claude -p` が `.mcp.json` を読んで npx MCP サーバーを起動する際のハング
- **改善案**: Claude Code 側で MCP サーバー起動にタイムアウトを設ける、または `claude -p` で MCP を無効化するフラグ（`--no-mcp` 等）を提供
- **復元手順**: `docs/MEM0-RESTORE.md` に記録済み
- **代替策**: past_topics.json の直近30日フィルタリング（スクリプト側前処理）で当面は十分

### 2. Opus テーマ選定（今回軽量再実装済み）

- **前回のブロッカー**: MCP ハング + 同一ターミナル問題で検証不能だった
- **現在**: `.mcp.json` 削除 + 軽量プロンプトで再実装済み。E2E 検証待ち
- **期待効果**: テーマ選定スコア +28%（LLM-as-Judge 評価より）、追加コスト $0.3-0.5/回

### 3. エージェントチーム版の改良

- **ブロッカー**: Task サブエージェントが親の `--model` を継承しない（Haiku フォールバック）
- **改善案**: Claude Code の Task ツールでモデル指定を継承可能にする、または各 Task で明示的にモデルを指定
- **費用対効果**: 現状のテーマ選定以外の品質差は +6% で、9倍の時間・2倍のコストに見合わない。テーマ選定だけ Opus に分離する方が合理的（今回の再実装がまさにこれ）

---

## リバート後の現在の状態

- **ベース**: `a79074e`（セキュリティ修正済みの安定版）
- **追加変更**:
  - Opus テーマ選定の軽量実装（Pass 1: 10分タイムアウト）
  - `--allowedTools` に Edit 追加
  - チーム版チェーン実行の削除
  - `.mcp.json` 削除（復元手順は `docs/MEM0-RESTORE.md`）
  - `validate_theme_json` のエラーログ改善
- **未検証**: Opus テーマ選定 → Sonnet リサーチの E2E 実行

---

## 今後のアクション

1. **E2E 検証**: 別ターミナル（tmux）で `./scripts/daily-research.sh` を実行し、2パス方式の動作確認
2. **past_topics.json 前処理**: データ肥大化に備え、直近30日分のみ抽出して `claude -p` に渡す仕組みを検討
3. **コミット + プッシュ**: 検証成功後にコミット。PUBLIC リポジトリなので内容確認必須
4. **Mem0 復活の監視**: Claude Code のリリースノートで MCP 初期化改善を追跡

---

## 要約: 3つの教訓

1. **1機能ずつ入れて検証する**。特にランタイム環境（`claude -p`, MCP, launchd）が絡む変更は、E2E テストを通すまで次に進まない
2. **テスト環境と本番環境の差異を意識する**。対話セッション ≠ `claude -p`、ローカルターミナル ≠ launchd 環境 ≠ SSH 環境
3. **Opus の価値はテーマ選定にある**。フルオーケストレーターとしては費用対効果が悪い。得意な部分だけ切り出して使う方が合理的
